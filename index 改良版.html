<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Infinite Stairs Space</title>

<style>
body {
  margin: 0;
  overflow: hidden;
  background: black;
  color: white;
  font-family: monospace;
}

/* ===== 星空背景 ===== */
#stars, #constellation {
  position: fixed;
  inset: 0;
  z-index: -2;
}

#stars {
  background:
    radial-gradient(circle at 20% 30%, #fff 1px, transparent 1px),
    radial-gradient(circle at 70% 80%, #aaa 1px, transparent 1px),
    radial-gradient(circle at 40% 60%, #ccc 1px, transparent 1px);
  background-size: 200px 200px;
  animation: scroll 20s linear infinite;
}

#constellation {
  z-index: -1;
  background-image:
    linear-gradient(30deg, rgba(255,255,255,0.15) 1px, transparent 1px),
    linear-gradient(-30deg, rgba(255,255,255,0.15) 1px, transparent 1px);
  background-size: 300px 300px;
  animation: scroll 30s linear infinite;
}

@keyframes scroll {
  from { background-position-y: 0; }
  to   { background-position-y: 600px; }
}

/* ===== UI ===== */
#menu {
  text-align: center;
  margin-top: 40px;
}

button {
  font-size: 18px;
  padding: 6px 18px;
  margin: 8px;
}

#gameArea { display: none; }

#close {
  position: fixed;
  top: 10px;
  left: 10px;
  font-size: 22px;
  cursor: pointer;
}

/* ===== ステージ ===== */
#stairs {
  position: relative;
  width: 320px;
  height: 520px;
  margin: 40px auto;
  overflow: visible;
}

/* ===== プレイヤー ===== */
#player {
  position: absolute;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  width: 32px;
  height: 40px;
  background: #666;
}

/* ===== 階段 ===== */
.step {
  position: absolute;
  transition: transform 0.15s linear;
}

.stair {
  width: 90px;
  height: 8px;
  background: white;
  border-radius: 4px;
}

/* ===== ミス演出 ===== */
#overlay {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  font-size: 40px;
  backdrop-filter: blur(3px);
}
</style>
</head>

<body>

<div id="stars"></div>
<div id="constellation"></div>

<!-- メニュー -->
<div id="menu">
  <h2>Infinite Stairs Space</h2>
  <button onclick="start()">START</button>
</div>

<!-- ゲーム -->
<div id="gameArea">
  <div id="close" onclick="back()">×</div>
  <p style="text-align:center">
    COMBO: <span id="combo">0</span> /
    MAX: <span id="maxCombo">0</span>
  </p>

  <div id="stairs">
    <div id="player"></div>
  </div>
</div>

<div id="overlay">MISS</div>

<script>
/* ===== 定数 ===== */
const STEP_COUNT = 8;
const STEP_GAP = 60;
const BASE_Y = 420;
const CENTER_X = 110;
const LEFT_X = -20;
const RIGHT_X = 240;

/* ===== 状態 ===== */
let stairs = [];
let combo = 0;
let maxCombo = 0;
let lastTime = 0;
let disabled = false;

/* ===== 要素 ===== */
const stairsEl = document.getElementById("stairs");
const comboEl = document.getElementById("combo");
const maxComboEl = document.getElementById("maxCombo");
const overlay = document.getElementById("overlay");

/* ===== 階段生成 ===== */
function nextStair(prev) {
  if (!prev || prev === "C") return Math.random() < 0.5 ? "L" : "R";
  return Math.random() < 0.7 ? (prev === "L" ? "R" : "L") : prev;
}

/* ===== 開始 ===== */
function start() {
  document.getElementById("menu").style.display = "none";
  document.getElementById("gameArea").style.display = "block";

  stairs = ["C"];
  for (let i = 1; i < STEP_COUNT; i++) {
    stairs.push(nextStair(stairs[i - 1]));
  }

  combo = 0;
  maxCombo = 0;
  comboEl.textContent = 0;
  maxComboEl.textContent = 0;
  draw();
}

function back() {
  document.getElementById("gameArea").style.display = "none";
  document.getElementById("menu").style.display = "block";
}

/* ===== 描画 ===== */
function draw() {
  stairsEl.innerHTML = '<div id="player"></div>';

  stairs.forEach((s, i) => {
    const step = document.createElement("div");
    step.className = "step";

    const x =
      s === "L" ? LEFT_X :
      s === "R" ? RIGHT_X :
      CENTER_X;

    step.style.transform =
      `translate(${x}px, ${BASE_Y - i * STEP_GAP}px)`;

    const bar = document.createElement("div");
    bar.className = "stair";
    step.appendChild(bar);

    stairsEl.appendChild(step);
  });
}

/* ===== 成功 / 失敗 ===== */
function success() {
  const now = Date.now();
  const limit = Math.max(300, 1200 - combo * 30);

  combo = now - lastTime <= limit ? combo + 1 : 1;
  lastTime = now;
  maxCombo = Math.max(maxCombo, combo);

  comboEl.textContent = combo;
  maxComboEl.textContent = maxCombo;

  stairs.shift();
  stairs.push(nextStair(stairs[stairs.length - 1]));
  draw();
}

function miss() {
  disabled = true;
  combo = 0;
  comboEl.textContent = 0;
  overlay.style.display = "flex";

  setTimeout(() => {
    overlay.style.display = "none";
    disabled = false;
  }, 500);
}

/* ===== 操作 ===== */
document.addEventListener("keydown", e => {
  if (disabled) return;

  const cur = stairs[0];
  if (cur === "C") return success();

  if (e.key === "a" || e.key === "A")
    cur === "L" ? success() : miss();

  if (e.key === "d" || e.key === "D")
    cur === "R" ? success() : miss();
});
</script>

</body>
</html>
